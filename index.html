<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  body { margin: 0; background: #f7f7f9; color: #1e1e1e; }
  header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fff; border-bottom: 1px solid #e5e5ea; }
  #portal-title { font-size: 18px; font-weight: 600; }
  #project-selector { padding: 6px 8px; }

  /* Top tabs styled as folder tabs */
  nav#tabs {
    display: flex;
    gap: 4px;
    padding: 0 16px;
    background: #f7f7f9;
    border-bottom: 2px solid #ccc;
  }

  nav#tabs button {
    background: #e0e0e0;
    color: #333;
    border: 1px solid #ccc;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    padding: 10px 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  nav#tabs button.active {
    background: #fff;
    color: #000;
    border-bottom: 2px solid #fff;
  }

  nav#tabs button:hover {
    background: #f5f5f5;
  }

  /* Subtabs row under active folder */
  nav#subtabs {
    display: flex;
    gap: 6px;
    padding: 6px 16px;
    background: #fff;
    border-bottom: 1px solid #ddd;
  }

  nav#subtabs button {
    background: #2979ff;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.2s;
  }

  nav#subtabs button.active {
    background: #1565c0;
  }

  nav#subtabs button:hover {
    background: #1565c0;
  }

  nav#subtabs button:disabled {
    background: #90caf9;
    color: #e0e0e0;
    cursor: not-allowed;
  }

  /* Global button styles */
  button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    background: #2979ff;
    color: #fff;
  }

  button:hover {
    background: #1565c0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  button:disabled {
    background: #90caf9;
    color: #e0e0e0;
    cursor: not-allowed;
  }

  button.primary {
    background: #2979ff;
    color: #fff;
  }

  button.primary:hover {
    background: #1565c0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  button.secondary {
    background: #2196f3;
    color: #fff;
  }

  button.secondary:hover {
    background: #1976d2;
  }

  button.danger {
    background: #e53935;
    color: #fff;
  }

  button.danger:hover {
    background: #c62828;
  }

  main#content { padding: 16px; }
  .card { background: #fff; border: 1px solid #e5e5ea; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
  .muted { color: #666; }
  .row { display: flex; align-items: center; gap: 8px; }
  .spacer { flex: 1; }
  .loader { font-size: 14px; color: #666; }
  .hidden { display: none !important; }

/* üßæ Note History Table Styling */
.notes-table-container {
  padding: 16px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.notes-table-container table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}

.notes-table-container thead {
  background: #f0f0f0;
  border-bottom: 2px solid #ccc;
}

.notes-table-container th {
  padding: 10px;
  text-align: left;
  font-weight: 600;
  border-right: 1px solid #ddd;
}

.notes-table-container td {
  padding: 8px;
  border-bottom: 1px solid #eee;
}

.notes-table-container tbody tr:nth-child(even) {
  background: #fafafa;
}

.notes-table-container tbody tr:hover {
  background: #e8f0ff;
}
</style>


</head>
<body>
  <header>
    <div class="row">
      <h1 id="portal-title">Client Portal</h1>
      <span class="muted" style="margin-left:12px;">v1.3.24</span>
    </div>
    <div class="row" id="project-selector-row">
      <label for="project-selector" class="muted">Project</label>
      <select id="project-selector"></select>
    </div>
  </header>

  <nav id="tabs"></nav>
  <nav id="subtabs" class="hidden"></nav>

  <main id="content"><div class="card"><p class="muted">Select a tab to start.</p></div></main>
<script>
const TAB_NAMES = {
  '1': 'Contacts',
  '2': 'Relationships',
  '3': 'Notes',
  '4': 'Tasks',
  '5': 'Lookups',
  '6': 'Dashboard'
};

const SUBTAB_NAMES = {
  notes: [
    { id: 'add', label: 'Add Note', disabled: false },
    { id: 'history', label: 'Note History', disabled: false },
    { id: 'review', label: 'Note Review', disabled: true },
    { id: 'relationships', label: 'Note Relationships', disabled: true }
  ]
};

let activeTab = null;
let activeSubtab = null;
let selectedNoteId = null;
let activeProject = null;
let projectConfig = null;

const API_BASE = 'https://client-portal-api.dennis-e64.workers.dev/api';
if (!window.activeProject) {
  const urlParams = new URLSearchParams(window.location.search);
  window.activeProject = urlParams.get("project") || "gtr";
}


  
/* ---------- Bootstrapping ---------- */
async function fetchProjectsList() {
  const res = await fetch(`${API_BASE}/projects_config`);
  if (!res.ok) throw new Error('Failed to load projects list');
  return res.json();
}

async function fetchProjectConfig(project) {
  const res = await fetch(`${API_BASE}/projects_config?project=${encodeURIComponent(project)}`);
  if (!res.ok) throw new Error('Failed to load project config');
  const data = await res.json();
  return Array.isArray(data) ? data[0] : data;
}

function setTitle(displayName) {
  const titleEl = document.getElementById('portal-title');
  titleEl.textContent = displayName || 'Client Portal';
  document.title = displayName || 'Client Portal';
}

function renderProjectSelector(projects, selected) {
  const sel = document.getElementById('project-selector');
  sel.innerHTML = '';
  projects.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.project;
    opt.textContent = p.display_name || p.project;
    if (p.project === selected) opt.selected = true;
    sel.appendChild(opt);
  });
  sel.onchange = async (e) => {
    await initPortal(e.target.value);
  };
}

async function initPortal(project) {
  activeProject = project;
  projectConfig = await fetchProjectConfig(project);
  setTitle(projectConfig.display_name);
  renderTabs(projectConfig.enabled_tabs || []);
  const firstTab = (projectConfig.enabled_tabs || [])[0] || '1';
  await loadTab(firstTab);
}

async function bootstrap() {
  try {
    const projects = await fetchProjectsList();
    const urlParams = new URLSearchParams(window.location.search);
    const projectParam = urlParams.get('project');
    const selectorRow = document.getElementById('project-selector-row');

    if (projectParam) {
      if (selectorRow) selectorRow.classList.add('hidden');
      activeProject = projectParam;
      await initPortal(activeProject);
    } else {
      if (selectorRow) selectorRow.classList.remove('hidden');
      const defaultProject = projects[0]?.project;
      renderProjectSelector(projects, defaultProject);
      await initPortal(defaultProject);
    }
  } catch (err) {
    document.getElementById('content').innerHTML =
      `<div class="card">Bootstrap error: ${err.message}</div>`;
  }
}

document.addEventListener('DOMContentLoaded', bootstrap);

/* ---------- Top tabs ---------- */
function renderTabs(enabledTabs = []) {
  const nav = document.getElementById('tabs');
  nav.innerHTML = '';
  enabledTabs.forEach(id => {
    const btn = document.createElement('button');
    btn.textContent = TAB_NAMES[id] || `Tab ${id}`;
    btn.dataset.tabId = id;
    btn.onclick = () => loadTab(id);
    if (id === activeTab) btn.classList.add('active');
    nav.appendChild(btn);
  });
}

function setActiveTabButton(id) {
  const nav = document.getElementById('tabs');
  [...nav.querySelectorAll('button')].forEach(b => {
    b.classList.toggle('active', b.dataset.tabId === id);
  });
}

/* ---------- Subtabs ---------- */
function renderSubtabs(tabKey) {
  const subnav = document.getElementById('subtabs');
  subnav.innerHTML = '';
  SUBTAB_NAMES[tabKey].forEach(st => {
    const btn = document.createElement('button');
    btn.textContent = st.label;
    btn.dataset.subtabId = st.id;
    btn.disabled = !!st.disabled;
    btn.classList.toggle('active', activeSubtab === st.id);
    btn.onclick = () => loadSubtab(tabKey, st.id);
    subnav.appendChild(btn);
  });
}

function setActiveSubtabButton(id) {
  const subnav = document.getElementById('subtabs');
  [...subnav.querySelectorAll('button')].forEach(b => {
    b.classList.toggle('active', b.dataset.subtabId === id);
  });
}

async function loadTab(id) {
  activeTab = id;
  setActiveTabButton(id);

  const subnav = document.getElementById('subtabs');
  if (id === '3') {
    renderSubtabs('notes');
    subnav.classList.remove('hidden');
  } else {
    subnav.classList.add('hidden');
    subnav.innerHTML = '';
    activeSubtab = null;
    selectedNoteId = null;
  }

  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading ${TAB_NAMES[id]}...</div>`;

  try {
    if (id === '3') await renderNotes(); // landing
    else if (id === '1') await renderContacts();
    else if (id === '2') await renderRelationships();
    else if (id === '4') await renderTasks();
    else if (id === '5') await renderLookups();
    else if (id === '6') await renderDashboard();
  } catch (err) {
    content.innerHTML = `<div class="card">Error: ${err.message}</div>`;
  }
}

async function loadSubtab(tabKey, subId) {
  activeSubtab = subId;
  setActiveSubtabButton(subId);
  if (tabKey === 'notes') {
    if (subId === 'add') await renderAddNoteForm();
    if (subId === 'history') await renderNoteHistory();
    if (subId === 'review') await renderNoteReview();
    if (subId === 'relationships') await renderNoteRelationships();
  }
}

/* ---------- Contacts ---------- */
async function renderContacts() {
  const content = document.getElementById('content');

  content.innerHTML = `
    <div class="card" style="margin-bottom:12px;">
      <div class="row" style="gap:12px;">
        <input id="filter-first" placeholder="First name" />
        <input id="filter-last" placeholder="Last name" />
        <input id="filter-email" placeholder="Email" />
        <button class="primary" onclick="findContacts()">Find</button>
      </div>
    </div>
    <div class="card">Enter criteria and click Find.</div>
  `;
}

async function findContacts() {
  const first = document.getElementById('filter-first').value.trim();
  const last = document.getElementById('filter-last').value.trim();
  const email = document.getElementById('filter-email').value.trim();

  if (email) {
    if (email.length < 3) { alert('Email must be at least 3 characters.'); return; }
  } else {
    if (!first || !last) { alert('Both first and last name required.'); return; }
    if (first.length < 3 || last.length < 3) { alert('Names must be at least 3 characters.'); return; }
  }

  let query = `project=${encodeURIComponent(activeProject)}`;
  if (email) {
    query += `&email=${encodeURIComponent(email)}`;
  } else {
    query += `&first_name=${encodeURIComponent(first)}&last_name=${encodeURIComponent(last)}`;
  }

  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Searching contacts...</div>`;

  const res = await fetch(`${API_BASE}/contacts?${query}`);
  if (!res.ok) {
    content.innerHTML = `<div class="card">Error searching contacts</div>`;
    return;
  }
  const rows = await res.json();

  const list = rows.map(r => `
    <div class="card">
      <div class="row">
        <strong>${r.first_name || ''} ${r.last_name || ''}</strong>
        <span class="spacer"></span>
        <span class="muted">${r.email || ''}</span>
      </div>
      <div class="row">
        <button onclick="openContact('${r.contact_id}')">Open</button>
      </div>
    </div>
  `).join('');

  renderContacts();
  document.getElementById('content').innerHTML += list || `<div class="card">No contacts found.</div>`;
}

async function openContact(contactId) {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading contact...</div>`;
  const [notesRes, relsRes, tasksRes] = await Promise.all([
    fetch(`${API_BASE}/notes?project=${encodeURIComponent(activeProject)}&contact_id=${encodeURIComponent(contactId)}`),
    fetch(`${API_BASE}/relationships?project=${encodeURIComponent(activeProject)}&contact_id=${encodeURIComponent(contactId)}`),
    fetch(`${API_BASE}/tasks?project=${encodeURIComponent(activeProject)}&contact_id=${encodeURIComponent(contactId)}`)
  ]);
  if (!notesRes.ok || !relsRes.ok || !tasksRes.ok) throw new Error('Failed to load contact details');
  const [notes, rels, tasks] = await Promise.all([notesRes.json(), relsRes.json(), tasksRes.json()]);
  content.innerHTML = `
    <div class="card">
      <div class="row">
        <strong>Contact</strong><span class="muted"> ${contactId}</span>
        <span class="spacer"></span>
        <button onclick="loadTab('1')">Back to Contacts</button>
      </div>
    </div>
    <div class="card"><strong>Notes</strong><div class="muted">${notes.length} notes</div></div>
    <div class="card"><strong>Relationships</strong><div class="muted">${rels.length} relationships</div></div>
    <div class="card"><strong>Tasks</strong><div class="muted">${tasks.length} tasks</div></div>
  `;
}

/* ---------- Relationships ---------- */
async function renderRelationships() {
  const content = document.getElementById('content');
  const res = await fetch(`${API_BASE}/relationships?project=${encodeURIComponent(activeProject)}`);
  if (!res.ok) throw new Error('Failed to load relationships');
  const rows = await res.json();
  content.innerHTML = rows.map(r => `
    <div class="card">
      <strong>${r.source_contact_id}</strong> ‚Üí <strong>${r.related_contact_id}</strong>
      <span class="muted"> (${r.relationship_type || 'relationship'})</span>
    </div>
  `).join('') || `<div class="card">No relationships found.</div>`;
}

/* ---------- Notes ---------- */
async function renderNotes() {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card muted">Choose a subtab above (Add Note, Note History, etc.).</div>`;
}

async function renderAddNoteForm() {
  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="card">
      <h3>Add Note <span class="muted">(Tech Admin Only)</span></h3>
      <div style="margin-bottom:12px;">
        <label><strong>Note / Email Content</strong></label><br />
        <textarea id="noteContent" placeholder="Paste the full text here..." rows="12" style="width:100%;"></textarea>
      </div>
      <div style="margin-bottom:12px;">
        <label><strong>External ID (optional)</strong></label><br />
        <input id="externalId" placeholder="e.g., Gmail ID, GHL note id" style="width:100%;" />
      </div>
      <div class="row">
        <button class="primary" id="uploadNoteBtn">Upload Note</button>
        <button class="secondary" id="clearNoteBtn">Clear</button>
      </div>
    </div>
  `;

document.getElementById('uploadNoteBtn').onclick = async () => {
  const note_text = document.getElementById('noteContent').value.trim();
  const external_id = document.getElementById('externalId').value.trim();
  if (!note_text) { alert('Note content is required.'); return; }

  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">üß† Updating... AI is processing your note. This may take up to 30 seconds.</div>`;

  try {
    const res = await fetch('https://add-note-module.dennis-e64.workers.dev', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        project: activeProject,
        raw_text: note_text,
        external_id: external_id || null
      })
    });

    const data = await res.json();
    if (res.ok && data.status === 'ok') {
      alert('‚úÖ Note saved and enriched.');
      selectedNoteId = data.note.id;
      enableNoteReviewSubtabs();
      await renderNoteHistory();
    } else {
      alert(data.error || 'Upload failed');
      console.error('Add note error:', data);
    }
  } catch (err) {
    alert('Upload failed');
    console.error('Fetch exception:', err);
  }
};


  document.getElementById('clearNoteBtn').onclick = () => {
    document.getElementById('noteContent').value = '';
    document.getElementById('externalId').value = '';
  };
}

function clearFilters() {
  document.getElementById("dateStart").value = "";
  document.getElementById("dateEnd").value = "";
  document.getElementById("filterNameEmail").value = "";
  loadNotes(); // reload default 7‚Äëday view
}
  
async function renderNoteHistory() {
  const content = document.getElementById('content');
  content.innerHTML = `
<div class="notes-table-container">
  <div class="row" style="gap:12px; margin-bottom:12px;">
  <label>Date Start: <input type="date" id="dateStart"></label>
  <label>Date End: <input type="date" id="dateEnd"></label>
  <label>Name/Email: <input type="text" id="filterNameEmail"></label>
  <button onclick="applyFilters()">Apply Filters</button>
  <button class="secondary" onclick="clearFilters()">Clear Filters</button>
</div>



    <table>
      <thead>
        <tr>
          <th>Created</th>
          <th>Subject</th>
          <th>From</th>
          <th>Client</th>
          <th>Needs Review</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="notesTableBody"></tbody>
    </table>
  </div>
`;


  // Auto-load last 7 days
  await loadNotes();
}

function toStartOfDayISO(dateStr) {
  const d = new Date(dateStr);
  d.setHours(0,0,0,0);
  return d.toISOString();
}

function toEndOfDayISO(dateStr) {
  const d = new Date(dateStr);
  d.setHours(23,59,59,999);
  return d.toISOString();
}
  
function buildQuery({ startDate, endDate, nameOrEmail, needsReview = true }) {
  const params = new URLSearchParams();
  if (startDate) params.set("start_date", startDate);
  if (endDate) params.set("end_date", endDate);
  if (nameOrEmail) params.set("name_or_email", nameOrEmail);
  params.set("needs_review", needsReview ? "true" : "false");
  return params.toString();
}

async function loadNotes() {
  const now = new Date();
  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

  const query = buildQuery({
    startDate: sevenDaysAgo.toISOString(),
    endDate: now.toISOString(),
    needsReview: true,
  });

  const res = await fetch(`https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&${query}`);


  const data = await res.json();
  if (data.status === "ok") {
    renderNotesTable(data.notes);
  } else {
    console.error("Failed to load notes:", data.error);
  }
}

async function applyFilters() {
  const startDate = document.getElementById("dateStart").value;
  const endDate = document.getElementById("dateEnd").value;
  const nameOrEmail = document.getElementById("filterNameEmail").value;

  const query = buildQuery({
  startDate: startDate ? toStartOfDayISO(startDate) : null,
  endDate: endDate ? toEndOfDayISO(endDate) : null,
  nameOrEmail,
  needsReview: true,
});


  const res = await fetch(`https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&${query}`);

  const data = await res.json();
  if (data.status === "ok") {
    renderNotesTable(data.notes);
  } else {
    console.error("Filter query failed:", data.error);
  }
}

function renderNotesTable(notes) {
  const tableBody = document.getElementById("notesTableBody");
  tableBody.innerHTML = "";
  notes.forEach(note => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${new Date(note.created_at).toLocaleString()}</td>
      <td>${note.subject || "(no subject)"}</td>
      <td>${note.from_name || ""}</td>
      <td>${note.client_contact_name || ""}</td>
      <td>${note.needs_review ? "Yes" : "No"}</td>
      <td>
        <button onclick="reviewNote('${note.id}')">Review</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

async function reviewNote(noteId) {
  selectedNoteId = noteId;
  const reviewBtn = document.querySelector('#subtabs [data-subtab-id="review"]');
  if (reviewBtn) reviewBtn.disabled = false;
  await loadSubtab('notes', 'review');
}


  
async function deleteNote(noteId) {
  const res = await fetch(`${API_BASE}/notes_history?id=eq.${noteId}`, {
    method: "DELETE"
  });
  if (res.ok) {
    alert("Note deleted!");
    await loadNotes();
  }
}


function enableNoteReviewSubtabs() {
  const reviewBtn = document.querySelector('#subtabs [data-subtab-id="review"]');
  const relBtn = document.querySelector('#subtabs [data-subtab-id="relationships"]');
  if (reviewBtn) reviewBtn.disabled = false;
  if (relBtn) relBtn.disabled = false;
}

async function renderNoteReview() {
  const content = document.getElementById('content');
  if (!selectedNoteId) {
    content.innerHTML = `<div class="card">Select a note in history first.</div>`;
    return;
  }

  content.innerHTML = `<div class="card loader">Loading note review...</div>`;

  try {
    const res = await fetch(
      `https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&id=eq.${selectedNoteId}`
    );
    const data = await res.json();
    if (data.status !== "ok" || !Array.isArray(data.notes)) {
      throw new Error("Invalid response");
    }

    const note = data.notes.find(n => n.id === selectedNoteId);
    if (!note) throw new Error("Note not found");

    let relationships = [];
    try {
      const relRes = await fetch(
        `https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&note_id=eq.${selectedNoteId}&table=notes_relationships`
      );
      const relData = await relRes.json();
      if (relData.status === "ok" && Array.isArray(relData.notes)) {
        relationships = relData.notes;
      }
    } catch (err) {
      console.warn("Failed to load relationships:", err);
    }

    content.innerHTML = `
      <div class="card">
<div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
  <h3 style="margin:0;">Note Review</h3>
  <button onclick="toggleSetClientForm()">Set Client</button>
  <button onclick="deleteNote()" class="danger">Delete</button>
</div>

<div id="setClientForm" style="display:none;">
  <div class="card" style="margin-bottom:12px;">
    <div class="row" style="gap:12px;">
      <input id="filter-first" placeholder="First name" />
      <input id="filter-last" placeholder="Last name" />
      <input id="filter-email" placeholder="Email" />
      <button class="primary" onclick="findClientContacts()">Find</button>
    </div>
  </div>
  <div id="clientSearchResults" class="card">Enter criteria and click Find.</div>
</div>

        <p><strong>Subject:</strong> ${note.subject || "(no subject)"}</p>
        <p><strong>From:</strong> ${note.from_name || ""} (${note.from_email || ""})</p>
        <p><strong>Created:</strong> ${new Date(note.created_at).toLocaleString()}</p>
        <p><strong>Client:</strong> ${note.client_contact_name || "(not set)"}</p>
        <p><strong>Status:</strong> ${note.review_status || "pending"} ‚Ä¢ Needs review: ${note.needs_review ? "Yes" : "No"}</p>
        <hr />
        <p><strong>Summary:</strong></p>
        <div style="margin-bottom:12px;">${note.summary || "(no summary available)"}</div>
        <details>
          <summary style="cursor:pointer; font-weight:600;">‚ñº Raw Text (click to expand)</summary>
          <pre style="white-space:pre-wrap; margin-top:8px;">${note.raw_text || ""}</pre>
        </details>

    `;

    if (relationships.length > 0) {
      content.innerHTML += `
        <div class="card" style="margin-top:16px;">
        <div style="display: flex; align-items: baseline; gap: 0.5em; margin-top: 1em;">
          <h4 style="margin: 0;">Participants Detected in Note</h4>
          <button id="noteRelationshipsBtn"
                  class="btn btn-sm btn-secondary"
                  onclick="openNoteRelationshipsTab('${note.id}', '${note.client_id}')">
            Note Relationships
          </button>
        </div>

          <table style="width:100%; border-collapse:collapse;">
            <thead style="background:#f0f0f0;">
              <tr>
                <th style="text-align:left; padding:8px;">Raw Name</th>
                <th style="text-align:left; padding:8px;">AI First</th>
                <th style="text-align:left; padding:8px;">AI Last</th>
                <th style="text-align:left; padding:8px;">Role/Type</th>
                <th style="text-align:left; padding:8px;">Context</th>
              </tr>
            </thead>
            <tbody>
              ${relationships.map((r, i) => `
                <tr style="background:${i % 2 === 0 ? "#fff" : "#f9f9f9"};">
                  <td style="padding:8px;">${r.raw_name || ""}</td>
                  <td style="padding:8px;">${r.first_name_ai || ""}</td>
                  <td style="padding:8px;">${r.last_name_ai || ""}</td>
                  <td style="padding:8px;">${r.role_label_ai || ""}</td>
                  <td style="padding:8px;">${r.context_description_ai || ""}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    // Wire up search input
    setTimeout(() => {
      const input = document.getElementById("clientSearchInput");
      if (input) {
        input.addEventListener("input", async (e) => {
          const query = e.target.value.trim();
          if (!query) return;

          const res = await fetch(`https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&table=contacts&or=(name.ilike.*${query}*,email.ilike.*${query}*)`);
          const data = await res.json();
          const results = data.notes || [];

          const container = document.getElementById("clientSearchResults");
          container.innerHTML = results.map(c => `
            <div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer;" onclick="attachClientToNote('${c.id}', '${c.name}', '${c.type}')">
              <strong>${c.name}</strong><br/><small>${c.email}</small>
            </div>
          `).join("");
        });
      }
    }, 100);
  } catch (err) {
    content.innerHTML = `<div class="card">Error loading note: ${err.message}</div>`;
  }
}

function toggleSetClientForm() {
  const form = document.getElementById("setClientForm");
  form.style.display = form.style.display === "none" ? "block" : "none";
}

async function findClientContacts() {
  const first = document.getElementById('filter-first').value.trim();
  const last = document.getElementById('filter-last').value.trim();
  const email = document.getElementById('filter-email').value.trim();

  // Validate input
  if (email) {
    if (email.length < 3) {
      alert('Email must be at least 3 characters.');
      return;
    }
  } else if (!first && !last) {
    alert('Enter at least a first or last name.');
    return;
  }

  const params = new URLSearchParams();

  // Build flexible filter
  if (email) {
    params.set('project', activeProject);
    params.set('email', `ilike.*${email}*`);
  } else {
    const filters = [`project.eq.${activeProject}`];
    if (first) filters.push(`first_name.ilike.*${first}*`);
    if (last)  filters.push(`last_name.ilike.*${last}*`);

    if (filters.length > 1) {
      params.set('and', `(${filters.join(',')})`);
    } else {
      const [filter] = filters;
      const [key, operator, value] = filter.split('.');
      params.set(`${key}.${operator}`, value);
    }
  }

  const url = `${API_BASE}/contacts?${params.toString()}&select=contact_id,first_name,last_name,email,type`;
  console.log('Contacts fetch (Note Review):', url);

  let res;
  try {
    res = await fetch(url);
  } catch (e) {
    alert('Network error searching contacts');
    console.error(e);
    return;
  }

  if (!res.ok) {
    const msg = await res.text().catch(() => '');
    alert(`Search failed (${res.status}). ${msg}`);
    return;
  }

  const rows = await res.json();
  const container = document.getElementById('clientSearchResults');
  container.innerHTML = rows.length > 0
    ? rows.map(r => {
        const fullName = `${r.first_name || ''} ${r.last_name || ''}`.trim();
        const typeLabel = r.type ? r.type.toLowerCase() : 'contact';

        return `
          <div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer;"
               onclick="attachClientToNote('${r.contact_id}', '${fullName}', '${typeLabel}')">
            <strong>${fullName}</strong>
            <span style="background:#eef; color:#336; padding:2px 6px; border-radius:12px; font-size:0.75em; margin-left:6px;">
              ${typeLabel}
            </span><br/>
            <small>${r.email || ''}</small>
          </div>
        `;
      }).join('')
    : `<div class="muted">No contacts found.</div>`;
}

  
async function attachClientToNote(contactId, contactName, contactType) {
  try {
    const res = await fetch(
      `https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&id=eq.${selectedNoteId}`,
      {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          client_contact_id: contactId,
          client_contact_name: contactName,
          client_contact_type: contactType,
          updated_at: new Date().toISOString()
        })
      }
    );

    if (!res.ok) {
      const msg = await res.text().catch(() => "");
      alert(`‚ùå Failed to attach client (${res.status}). ${msg}`);
      console.error("Attach client error:", msg);
      return;
    }

    // Success ‚Äî give reviewer immediate confirmation
    alert(`‚úÖ Client set: ${contactName} (${contactType})`);

    // Hide the search form and reload the note review
    document.getElementById("setClientForm").style.display = "none";
    await renderNoteReview();
  } catch (err) {
    alert("‚ùå Network error attaching client");
    console.error("Attach client exception:", err);
  }
}



  
function openSetClientForm() {
  document.getElementById("setClientForm").style.display = "block";
  document.getElementById("clientSearchInput").focus();
}

async function attachClientToNote(contactId, contactName, contactType) {
  await fetch(`https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&id=eq.${selectedNoteId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      client_contact_id: contactId,
      client_contact_name: contactName,
      client_contact_type: contactType,
      updated_at: new Date().toISOString()
    })
  });

  document.getElementById("setClientForm").style.display = "none";
  renderNoteReview();
}

async function deleteNote() {
  if (!confirm("Are you sure you want to delete this note?")) return;

  await fetch(`https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&id=eq.${selectedNoteId}`, {
    method: "DELETE"
  });

  selectedNoteId = null;
  renderNoteReview();
  renderNoteHistory();
}

function openNoteRelationshipsTab(noteId, clientId) {
  // Set globals so renderNoteRelationships() knows what to load
  selectedNoteId = noteId;
  currentClientId = clientId;

  // Render the relationships tab dynamically into #content
  renderNoteRelationships();
}

  
async function renderNoteRelationships() {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading Note Relationships...</div>`;

  try {
    const lookups = await fetchLookups(activeProject);
    console.log("Lookups fetched:", lookups);

    // Example rows until you wire actual note_relationships
    const noteRows = [
      { id: 1, first_name_ai: "Mickie", last_name_ai: "Mouse", role_label_ai: "", context_description_ai: "Recipient of the email" },
      { id: 2, first_name_ai: "Donald", last_name_ai: "Duck", role_label_ai: "", context_description_ai: "Recipient of the email" }
    ];

    renderNoteRelationshipGrid(noteRows, lookups.types, lookups.roles, activeProject);
  } catch (err) {
    content.innerHTML = `<div class="card">Error loading relationships: ${err.message}</div>`;
  }
}

/* ---------- Lookups ---------- */
async function fetchLookups(project) {
  try {
    const [typesRes, rolesRes] = await Promise.all([
      fetch(`${API_BASE}/lookups?project=${encodeURIComponent(project)}&type=relationship_type`).then(r => r.json()),
      fetch(`${API_BASE}/lookups?project=${encodeURIComponent(project)}&type=relationship_role`).then(r => r.json())
    ]);

    console.log("Types response:", typesRes);
    console.log("Roles response:", rolesRes);

    return {
      types: Array.isArray(typesRes.values) ? typesRes.values.map(v => v.value) : [],
      roles: Array.isArray(rolesRes.values) ? rolesRes.values.map(v => v.value) : []
    };
  } catch (err) {
    console.error("Error fetching lookups:", err);
    return { types: [], roles: [] };
  }
}

/* ---------- Grid Renderer ---------- */
function renderNoteRelationshipGrid(noteRows, types, roles, clientId) {
  const container = document.getElementById('content');

  const safeTypes = Array.isArray(types) ? types : [];
  const safeRoles = Array.isArray(roles) ? roles : [];

  container.innerHTML = `
    <div class="notes-table-container">
      <table>
        <thead>
          <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Context</th>
            <th>Relationship Type</th>
            <th>Relationship Role</th>
            <th>Email</th>
            <th>Promote</th>
          </tr>
        </thead>
        <tbody>
          ${noteRows.map(r => `
            <tr data-id="${r.id}" data-contact-id="${r.contact_id || ''}">
              <td><input class="first-name" value="${r.first_name_ai || ''}" /></td>
              <td><input class="last-name" value="${r.last_name_ai || ''}" /></td>
              <td>${r.context_description_ai || ''}</td>
              <td>
                <select class="rel-type">
                  ${safeTypes.map(t => `
                    <option value="${t}" ${r.relationship_type === t ? 'selected' : ''}>${t}</option>
                  `).join('')}
                </select>
              </td>
              <td>
                <select class="rel-role">
                  ${safeRoles.map(role => `
                    <option value="${role}" ${r.relationship_role === role ? 'selected' : ''}>${role}</option>
                  `).join('')}
                </select>
              </td>
              <td><input class="rel-email" value="${r.related_email || ''}" /></td>
              <td><input type="checkbox" class="promote-checkbox" /></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <button class="primary" onclick="saveRelationships()">Save Relationships</button>
    </div>
  `;
}

/* ---------- Save Handler ---------- */
async function saveRelationships() {
  try {
    // Collect rows from the grid
    const rows = [...document.querySelectorAll('#content tbody tr')];

    // Build updates payload
    const updates = rows.map(row => ({
      id: row.dataset.id,
      relationship_type: row.querySelector('.rel-type')?.value || null,
      relationship_role: row.querySelector('.rel-role')?.value || null,
      related_email: row.querySelector('.rel-email')?.value.trim() || null
    }));

    console.log("Sending PATCH updates:", updates);

    // Send PATCH to notes_relationships
    const res = await fetch(`${API_BASE}/note_relationships`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ project: activeProject, updates })
    });

    const data = await res.json();
    console.log("PATCH results:", data);

    if (res.ok && data.success) {
      alert("‚úÖ Relationships saved successfully");
    } else {
      alert("‚ùå Failed to save relationships");
      console.error("Save error:", data);
    }

    // üö´ Bulk insert removed for now
    // We‚Äôll reintroduce contact_relationships promotion later
  } catch (err) {
    alert("‚ùå Save failed");
    console.error("Save exception:", err);
  }
}








function renderContactRelationshipGrid(rows) {
  const container = document.getElementById('existingContactRelationshipsGrid');

  if (!Array.isArray(rows) || rows.length === 0) {
    container.innerHTML = `<div class="muted">No existing global relationships.</div>`;
    return;
  }

  container.innerHTML = rows.map(r => `
    <div class="grid-row">
      <div class="cell">${r.source_contact_id} ‚Üî ${r.related_contact_id}</div>
      <div class="cell">${r.relationship_type || ''}</div>
      <div class="cell">${r.relationship_level || ''}</div>
    </div>
  `).join('');
}
  

/* ---------- Tasks ---------- */
async function renderTasks(filter = 'open') {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading tasks...</div>`;

  const res = await fetch(`${API_BASE}/tasks?project=${encodeURIComponent(activeProject)}&status=${filter}`);
  if (!res.ok) {
    content.innerHTML = `<div class="card">Error loading tasks</div>`;
    return;
  }
  const rows = await res.json();

  const filters = `
    <div class="row" style="margin-bottom:12px;">
      <button onclick="renderTasks('all')">All</button>
      <button onclick="renderTasks('open')">Open</button>
      <button onclick="renderTasks('completed')">Completed</button>
      <button onclick="renderTasks('overdue')">Overdue</button>
    </div>
  `;

  const list = rows.map(t => {
    const overdue = t.status === 'open' && t.due_date && new Date(t.due_date) < new Date();
    const statusBadge = overdue ? `<span style="color:red;">‚ö†Ô∏è Overdue</span>` : `<span class="muted">${t.status}</span>`;
    const actionBtn = t.status === 'open'
      ? `<button onclick="markTaskDone('${t.id}')">Mark done</button>`
      : `<button onclick="reopenTask('${t.id}')">Reopen</button>`;

    return `
      <div class="card">
        <strong>${t.description}</strong>
        <div class="muted">
          ${t.assigned_to ? 'Assigned: ' + t.assigned_to : 'Unassigned'}
          ${t.due_date ? ' ‚Ä¢ Due: ' + t.due_date : ''}
        </div>
        <div class="row" style="margin-top:8px;">
          ${statusBadge}
          <span class="spacer"></span>
          ${actionBtn}
        </div>
      </div>
    `;
  }).join('');

  content.innerHTML = filters + (list || `<div class="card">No tasks found.</div>`);
}

async function reopenTask(taskId) {
  const res = await fetch(`${API_BASE}/tasks/${encodeURIComponent(taskId)}/reopen`, { method: 'POST' });
  if (!res.ok) { alert('Failed to reopen task'); return; }
  await renderTasks('open');
}

async function markTaskDone(taskId) {
  const res = await fetch(`${API_BASE}/tasks/${encodeURIComponent(taskId)}/complete`, { method: 'POST' });
  if (!res.ok) { alert('Failed to complete task'); return; }
  await renderTasks();
}

/* ---------- Lookups ---------- */
async function renderLookups() {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading lookups...</div>`;

  const res = await fetch(`${API_BASE}/lookups?project=${encodeURIComponent(activeProject)}`);
  if (!res.ok) {
    content.innerHTML = `<div class="card">Error loading lookups</div>`;
    return;
  }
  const rows = await res.json();

  const grouped = {};
  rows.forEach(l => {
    grouped[l.category] = grouped[l.category] || [];
    grouped[l.category].push(l);
  });

  const html = Object.keys(grouped).map(cat => {
    const items = grouped[cat].map(l => `<li><strong>${l.key}</strong>: ${l.value}</li>`).join('');
    return `
      <div class="card">
        <strong>${cat}</strong>
        <ul>${items}</ul>
      </div>
    `;
  }).join('');

  content.innerHTML = html || `<div class="card">No lookups defined.</div>`;
}

/* ---------- Dashboard ---------- */
async function renderDashboard() {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading dashboard...</div>`;

  const res = await fetch(`${API_BASE}/dashboard?project=${encodeURIComponent(activeProject)}`);
  if (!res.ok) {
    content.innerHTML = `<div class="card">Error loading dashboard</div>`;
    return;
  }
  const kpis = await res.json();

  const cards = `
    <div class="card"><strong>Open tasks</strong><div>${kpis.open_tasks ?? 0}</div></div>
    <div class="card"><strong>Overdue tasks</strong><div>${kpis.overdue_tasks ?? 0}</div></div>
    <div class="card"><strong>Completed tasks (7d)</strong><div>${kpis.completed_tasks_7d ?? 0}</div></div>
    <div class="card"><strong>Total relationships</strong><div>${kpis.total_relationships ?? 0}</div></div>
    <div class="card"><strong>Notes added (7d)</strong><div>${kpis.notes_added_7d ?? 0}</div></div>
  `;

  const chartId = 'notesChart';
  const chartCanvas = `<canvas id="${chartId}" width="400" height="200"></canvas>`;

  content.innerHTML = cards + `<div class="card"><strong>Notes per contact (7d)</strong>${chartCanvas}</div>`;

  const ctx = document.getElementById(chartId).getContext('2d');
  const labels = Object.keys(kpis.notes_per_contact_7d || {});
  const data = Object.values(kpis.notes_per_contact_7d || {});
  if (labels.length > 0) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Notes',
          data,
          backgroundColor: '#84aef8'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  } else {
    ctx.font = '14px sans-serif';
    ctx.fillText('No notes in last 7 days', 20, 50);
  }
}
</script>
</body>
</html>
