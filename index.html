<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  body { margin: 0; background: #f7f7f9; color: #1e1e1e; }
  header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fff; border-bottom: 1px solid #e5e5ea; }
  #portal-title { font-size: 18px; font-weight: 600; }
  #project-selector { padding: 6px 8px; }
  /* ... keep all your CSS from v1.2.2 unchanged ... */
</style>
</head>
<body>
  <header>
    <div class="row">
      <h1 id="portal-title">Client Portal</h1>
      <span class="muted" style="margin-left:12px;">v1.2.3</span>
    </div>
    <div class="row" id="project-selector-row">
      <label for="project-selector" class="muted">Project</label>
      <select id="project-selector"></select>
    </div>
  </header>

  <nav id="tabs"></nav>
  <nav id="subtabs" class="hidden"></nav>

  <main id="content"><div class="card"><p class="muted">Select a tab to start.</p></div></main>
<script>
const TAB_NAMES = { '1':'Contacts','2':'Relationships','3':'Notes','4':'Tasks','5':'Lookups','6':'Dashboard' };
const SUBTAB_NAMES = { notes:[{id:'add',label:'Add Note',disabled:false},{id:'history',label:'Note History',disabled:false},{id:'review',label:'Note Review',disabled:true},{id:'relationships',label:'Note Relationships',disabled:true}] };

let activeTab=null, activeSubtab=null, selectedNoteId=null, activeProject=null, projectConfig=null;

const API_BASE = 'https://client-portal-api.dennis-e64.workers.dev/api';
if (!window.activeProject) {
  const urlParams = new URLSearchParams(window.location.search);
  window.activeProject = urlParams.get("project") || "gtr";
}

async function fetchProjectsList() {
  const res = await fetch(`${API_BASE}/projects_config`);
  if (!res.ok) throw new Error('Failed to load projects list');
  return res.json();
}

async function fetchProjectConfig(project) {
  const res = await fetch(`${API_BASE}/projects_config?project=${encodeURIComponent(project)}`);
  if (!res.ok) throw new Error('Failed to load project config');
  const data = await res.json();
  return Array.isArray(data) ? data[0] : data;
}

function setTitle(displayName) {
  const titleEl=document.getElementById('portal-title');
  titleEl.textContent=displayName||'Client Portal';
  document.title=displayName||'Client Portal';
}

function renderProjectSelector(projects,selected) {
  const sel=document.getElementById('project-selector');
  sel.innerHTML='';
  projects.forEach(p=>{
    const opt=document.createElement('option');
    opt.value=p.project;
    opt.textContent=p.display_name||p.project;
    if(p.project===selected) opt.selected=true;
    sel.appendChild(opt);
  });
  sel.onchange=async(e)=>{ await initPortal(e.target.value); };
}

async function initPortal(project) {
  activeProject=project;
  projectConfig=await fetchProjectConfig(project);
  setTitle(projectConfig.display_name);
  renderTabs(projectConfig.enabled_tabs||[]);
  const firstTab=(projectConfig.enabled_tabs||[])[0]||'1';
  await loadTab(firstTab);
}

async function bootstrap() {
  try {
    const projects=await fetchProjectsList();
    const urlParams=new URLSearchParams(window.location.search);
    const projectParam=urlParams.get('project');
    const selectorRow=document.getElementById('project-selector-row');
    if(projectParam) {
      if(selectorRow) selectorRow.classList.add('hidden');
      activeProject=projectParam;
      await initPortal(activeProject);
    } else {
      if(selectorRow) selectorRow.classList.remove('hidden');
      const defaultProject=projects[0]?.project;
      renderProjectSelector(projects,defaultProject);
      await initPortal(defaultProject);
    }
  } catch(err) {
    document.getElementById('content').innerHTML=`<div class="card">Bootstrap error: ${err.message}</div>`;
  }
}
document.addEventListener('DOMContentLoaded',bootstrap);
function buildQuery({startDate,endDate,nameOrEmail,needsReview=true}) {
  const params=new URLSearchParams();
  if(startDate) params.set("start_date",startDate);
  if(endDate) params.set("end_date",endDate);
  if(nameOrEmail) params.set("name_or_email",nameOrEmail);
  params.set("needs_review",needsReview?"true":"false");
  return params.toString();
}

async function renderNoteHistory() {
  const content=document.getElementById('content');
  content.innerHTML=`
    <div class="notes-table-container">
      <div class="row" style="gap:12px; margin-bottom:12px;">
        <label>Date Start: <input type="date" id="dateStart"></label>
        <label>Date End: <input type="date" id="dateEnd"></label>
        <label>Name/Email: <input type="text" id="filterNameEmail"></label>
        <button onclick="applyFilters()">Apply Filters</button>
      </div>
      <table>
        <thead><tr><th>Created</th><th>Subject</th><th>From</th><th>Client</th><th>Needs Review</th><th>Actions</th></tr></thead>
        <tbody id="notesTableBody"></tbody>
      </table>
    </div>`;
  await loadNotes();
}

async function loadNotes() {
  const now=new Date();
  const sevenDaysAgo=new Date(now.getTime()-7*24*60*60*1000);
  const query=buildQuery({startDate:sevenDaysAgo.toISOString(),endDate:now.toISOString(),needsReview:true});
  const res=await fetch(`https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&${query}`);
  const data=await res.json();
  if(data.status==="ok") renderNotesTable(data.notes);
  else console.error("Failed to load notes:",data.error);
}

async function applyFilters() {
  const startDate=document.getElementById("dateStart").value;
  const endDate=document.getElementById("dateEnd").value;
  const nameOrEmail=document.getElementById("filterNameEmail").value;
  const query=buildQuery({
    startDate:startDate?new Date(startDate).toISOString():null,
    endDate:endDate?new Date(endDate).toISOString():null,
    nameOrEmail,
    needsReview:true
  });
  const res=await fetch(`https://notes-history-module.dennis-e64.workers.dev?project=${encodeURIComponent(activeProject)}&${query}`);
  const data=await res.json();
  if(data.status==="ok") renderNotesTable(data.notes);
  else console.error("Filter query failed:",data.error);
}
/* ---------- Contacts ---------- */
async function renderContacts() {
  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="card" style="margin-bottom:12px;">
      <div class="row" style="gap:12px;">
        <input id="filter-first" placeholder="First name" />
        <input id="filter-last" placeholder="Last name" />
        <input id="filter-email" placeholder="Email" />
        <button class="primary" onclick="findContacts()">Find</button>
      </div>
    </div>
    <div class="card">Enter criteria and click Find.</div>
  `;
}

async function findContacts() {
  const first = document.getElementById('filter-first').value.trim();
  const last = document.getElementById('filter-last').value.trim();
  const email = document.getElementById('filter-email').value.trim();

  if (email) {
    if (email.length < 3) { alert('Email must be at least 3 characters.'); return; }
  } else {
    if (!first || !last) { alert('Both first and last name required.'); return; }
    if (first.length < 3 || last.length < 3) { alert('Names must be at least 3 characters.'); return; }
  }

  let query = `project=${encodeURIComponent(activeProject)}`;
  if (email) {
    query += `&email=${encodeURIComponent(email)}`;
  } else {
    query += `&first_name=${encodeURIComponent(first)}&last_name=${encodeURIComponent(last)}`;
  }

  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Searching contacts...</div>`;

  const res = await fetch(`${API_BASE}/contacts?${query}`);
  if (!res.ok) {
    content.innerHTML = `<div class="card">Error searching contacts</div>`;
    return;
  }
  const rows = await res.json();

  const list = rows.map(r => `
    <div class="card">
      <div class="row">
        <strong>${r.first_name || ''} ${r.last_name || ''}</strong>
        <span class="spacer"></span>
        <span class="muted">${r.email || ''}</span>
      </div>
      <div class="row">
        <button onclick="openContact('${r.contact_id}')">Open</button>
      </div>
    </div>
  `).join('');

  renderContacts();
  document.getElementById('content').innerHTML += list || `<div class="card">No contacts found.</div>`;
}

async function openContact(contactId) {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading contact...</div>`;
  const [notesRes, relsRes, tasksRes] = await Promise.all([
    fetch(`${API_BASE}/notes?project=${encodeURIComponent(activeProject)}&contact_id=${encodeURIComponent(contactId)}`),
    fetch(`${API_BASE}/relationships?project=${encodeURIComponent(activeProject)}&contact_id=${encodeURIComponent(contactId)}`),
    fetch(`${API_BASE}/tasks?project=${encodeURIComponent(activeProject)}&contact_id=${encodeURIComponent(contactId)}`)
  ]);
  if (!notesRes.ok || !relsRes.ok || !tasksRes.ok) throw new Error('Failed to load contact details');
  const [notes, rels, tasks] = await Promise.all([notesRes.json(), relsRes.json(), tasksRes.json()]);
  content.innerHTML = `
    <div class="card">
      <div class="row">
        <strong>Contact</strong><span class="muted"> ${contactId}</span>
        <span class="spacer"></span>
        <button onclick="loadTab('1')">Back to Contacts</button>
      </div>
    </div>
    <div class="card"><strong>Notes</strong><div class="muted">${notes.length} notes</div></div>
    <div class="card"><strong>Relationships</strong><div class="muted">${rels.length} relationships</div></div>
    <div class="card"><strong>Tasks</strong><div class="muted">${tasks.length} tasks</div></div>
  `;
}

/* ---------- Relationships ---------- */
async function renderRelationships() {
  const content = document.getElementById('content');
  const res = await fetch(`${API_BASE}/relationships?project=${encodeURIComponent(activeProject)}`);
  if (!res.ok) throw new Error('Failed to load relationships');
  const rows = await res.json();
  content.innerHTML = rows.map(r => `
    <div class="card">
      <strong>${r.source_contact_id}</strong> → <strong>${r.related_contact_id}</strong>
      <span class="muted"> (${r.relationship_type || 'relationship'})</span>
    </div>
  `).join('') || `<div class="card">No relationships found.</div>`;
}

/* ---------- Tasks ---------- */
async function renderTasks(filter = 'open') {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading tasks...</div>`;

  const res = await fetch(`${API_BASE}/tasks?project=${encodeURIComponent(activeProject)}&status=${filter}`);
  if (!res.ok) {
    content.innerHTML = `<div class="card">Error loading tasks</div>`;
    return;
  }
  const rows = await res.json();

  const filters = `
    <div class="row" style="margin-bottom:12px;">
      <button onclick="renderTasks('all')">All</button>
      <button onclick="renderTasks('open')">Open</button>
      <button onclick="renderTasks('completed')">Completed</button>
      <button onclick="renderTasks('overdue')">Overdue</button>
    </div>
  `;

  const list = rows.map(t => {
    const overdue = t.status === 'open' && t.due_date && new Date(t.due_date) < new Date();
    const statusBadge = overdue ? `<span style="color:red;">⚠️ Overdue</span>` : `<span class="muted">${t.status}</span>`;
    const actionBtn = t.status === 'open'
      ? `<button onclick="markTaskDone('${t.id}')">Mark done</button>`
      : `<button onclick="reopenTask('${t.id}')">Reopen</button>`;

    return `
      <div class="card">
        <strong>${t.description}</strong>
        <div class="muted">
          ${t.assigned_to ? 'Assigned: ' + t.assigned_to : 'Unassigned'}
          ${t.due_date ? ' • Due: ' + t.due_date : ''}
        </div>
        <div class="row" style="margin-top:8px;">
          ${statusBadge}
          <span class="spacer"></span>
          ${actionBtn}
        </div>
      </div>
    `;
  }).join('');

  content.innerHTML = filters + (list || `<div class="card">No tasks found.</div>`);
}

async function reopenTask(taskId) {
  const res = await fetch(`${API_BASE}/tasks/${encodeURIComponent(taskId)}/reopen`, { method: 'POST' });
  if (!res.ok) { alert('Failed to reopen task'); return; }
  await renderTasks('open');
}

async function markTaskDone(taskId) {
  const res = await fetch(`${API_BASE}/tasks/${encodeURIComponent(taskId)}/complete`, { method: 'POST' });
  if (!res.ok) { alert('Failed to complete task'); return; }
  await renderTasks();
}

/* ---------- Lookups ---------- */
async function renderLookups() {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading lookups...</div>`;

  const res = await fetch(`${API_BASE}/lookups?project=${encodeURIComponent(activeProject)}`);
  if (!res.ok) {
    content.innerHTML = `<div class="card">Error loading lookups</div>`;
    return;
  }
  const rows = await res.json();

  const grouped = {};
  rows.forEach(l => {
    grouped[l.category] = grouped[l.category] || [];
    grouped[l.category].push(l);
  });

  const html = Object.keys(grouped).map(cat => {
    const items = grouped[cat].map(l => `<li><strong>${l.key}</strong>: ${l.value}</li>`).join('');
    return `
      <div class="card">
        <strong>${cat}</strong>
        <ul>${items}</ul>
      </div>
    `;
  }).join('');

  content.innerHTML = html || `<div class="card">No lookups defined.</div>`;
}

/* ---------- Dashboard ---------- */
async function renderDashboard() {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="card loader">Loading dashboard...</div>`;

  const res = await fetch(`${API_BASE}/dashboard?project=${encodeURIComponent(activeProject)}`);
  if (!res.ok) {
    content.innerHTML = `<div class="card">Error loading dashboard</div>`;
    return;
  }
  const kpis = await res.json();

  const cards = `
    <div class="card"><strong>Open tasks</strong><div>${kpis.open_tasks ?? 0}</div></div>
    <div class="card"><strong>Overdue tasks</strong><div>${kpis.overdue_tasks ?? 0}</div></div>
    <div class="card"><strong>Completed tasks (7d)</strong><div>${kpis.completed_tasks_7d ?? 0}</div></div>
    <div class="card"><strong>Total relationships</strong><div>${kpis.total_relationships ?? 0}</div></div>
    <div class="card"><strong>Notes added (7d)</strong><div>${kpis.notes_added_7d ?? 0}</div></div>
  `;

  const chartId = 'notesChart';
  const chartCanvas = `<canvas id="${chartId}" width="400" height="200"></canvas>`;

  content.innerHTML = cards + `<div class="card"><strong>Notes per contact (7d)</strong>${chartCanvas}</div>`;

  const ctx = document.getElementById(chartId).getContext('2d');
  const labels = Object.keys(kpis.notes_per_contact_7d || {});
  const data = Object.values(kpis.notes_per_contact_7d || {});
  if (labels.length > 0) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Notes',
          data,
          backgroundColor: '#84aef8'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  } else {
    ctx.font = '14px sans-serif';
    ctx.fillText('No notes in last 7 days', 20, 50);
  }
}
</script>
</body>
</html>
